<!DOCTYPE html>
<html lang="eng">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>
            Announcements
        </title>
        <style>
            body { font-family: Geneva; max-width: 800px; margin: 50px auto; padding: 20px; }
            .announcement { border: 1px solid #bed; padding: 15px; margin-bottom: 15px; border-radius: 5px; 
            background-color: #f9f9f9}
            .meta { color: #667; font-size: 0.9em; margin-bottom: 5px; }
            .teacher-controls { border: 2px solid #d9534d; padding: 15px; margin-bottom: 30px; border-radius: 5px; }
            textarea { width: 100%; height: 80px; margin-bottom: 10px; }
        </style>
    </head>
    <body>
        <h1>
            School Announcements
        </h1>
        <p><a href="/api/profile/">&larr; Back to Profile</a></p>

        <!-- Only show this form if the user is a teacher -->
         {% if g.user and g.user.role== 'teacher' %}
         <div class="teacher-controls">
            <h3>
                Post New Announcement
            </h3>
            <form id="post-form">
                <textarea name="message" id="message" placeholder="Type your announcement here please..." required></textarea>
                <button type="submit">
                    Post Announcement
                </button>
            </form>
            <div id="status-msg"></div>
         </div>
         {% endif %}

         <div id="announcements-list">
            {% for post in posts %}
            <div class="announcement">
                <div class="meta"> Posted by <strong>{{ post.author }}</strong> on {{ post.created }}</div>
                <div>{{ post.message }}</div>
            </div>
            {% endfor %}
         </div>

         <script>
            const postForm = document.getElementById('post-form');
            if (postForm) {
                postForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const message = document.getElementById('message').value;

                   const response = await fetch('/api/announcements/', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json'},
                    body: JSON.stringify({ message: message })
                   });

                    if (response.ok) {
                        window.location.reload(); // reload page to see new post
                    } else {
                        alert("Failed to post announcement. U gotta try again lil bro");
                    }
                });
            }
         </script>
    </body>
</html>